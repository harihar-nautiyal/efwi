import time
import getpass
from playwright.sync_api import sync_playwright

# --- JAVASCRIPT PAYLOAD ---
# This is the auto-completer script that will be executed in the browser's console.
# It will run after the Python script logs you in and navigates to the right page.
AUTO_COMPLETER_JS = """
async function runAutoCompleter() {
    // Configuration: Delay between completing each challenge (in milliseconds).
    const INTERVAL_MS = 1000; // 1 second

    if (typeof challenges === 'undefined' || challenges.length === 0) {
        console.error("Game data not loaded. Cannot start auto-completer.");
        window.autoCompleterFinished = true; // Signal completion to Python
        return;
    }

    console.log(`▶ Starting Auto-Completer...`);

    while (currentChallengeIndex < challenges.length) {
        // Ensure we don't get stuck on an already completed challenge
        if (currentChallengeIndex < completedChallenges) {
            currentChallengeIndex++;
            continue;
        }

        console.log(`Completing Challenge #${currentChallengeIndex + 1}: ${challenges[currentChallengeIndex].topic}`);

        // Simulate a correct solution
        websiteParts[currentChallengeIndex] = challenges[currentChallengeIndex].solution;
        completedChallenges = currentChallengeIndex + 1;
        points += 100; // Award a default of 100 points

        // Save progress and sync with the server (using the site's own functions)
        saveProgress();
        await SyncData(); // Use await since SyncData is async

        // Move to the next challenge
        currentChallengeIndex++;

        // Wait for the specified interval
        await new Promise(resolve => setTimeout(resolve, INTERVAL_MS));
    }

    // Final UI updates after the loop
    updateChallengeTracker();
    updateCumulativeCode(true);
    renderCodePreview();
    showCompletionModal();

    console.log("✅ All challenges have been completed!");
    window.autoCompleterFinished = true; // Signal completion to Python
}

// Immediately run the function and handle any errors.
runAutoCompleter().catch(err => {
    console.error("Error during auto-completion:", err);
    window.autoCompleterFinished = true; // Ensure Python script can terminate
});
"""


def main():
    """
    Main function to run the automation script.
    """
    # --- Get User Credentials ---
    # We ask for credentials securely instead of hardcoding them.
    email = input("Enter your Efiwe email: ")
    password = getpass.getpass("Enter your Efiwe password: ")

    with sync_playwright() as p:
        try:
            # Launch the browser. Set headless=True to run in the background.
            browser = p.chromium.launch(headless=False, slow_mo=50)
            page = browser.new_page()

            # 1. Go to the website
            print("Navigating to efiwe.com...")
            page.goto("https://efiwe.com/")

            # 2. Click the Login/Signup button to open the modal
            print("Opening the login modal...")
            page.locator("#loginSignupButton").click()

            # 3. Fill in the login credentials
            print("Filling in email and password...")
            page.locator("#loginEmail").fill(email)
            page.locator("#loginPassword").fill(password)

            # 4. Click the final login button
            print("Logging in...")
            page.locator("#loginButton").click()

            # Wait for the login to complete and the next page to load
            page.wait_for_load_state("networkidle")
            print("Login successful.")

            # 5. Click "Get Started Now!"
            print("Navigating to the 'learn' page...")
            page.locator('a:has-text("Get Started Now!")').click()

            # 6. Click "Learn HTML"
            print("Navigating to the HTML challenges...")
            page.locator('a:has-text("Learn HTML")').click()

            # Wait for the main challenge page to be fully interactive
            page.wait_for_load_state("networkidle")

            # 7. Click the "Start Game" button in the intro modal (if it appears)
            start_game_button = page.locator("#startGame")
            if start_game_button.is_visible():
                print(
                    "Closing intro modal by clicking 'Start Building while Learning!'..."
                )
                start_game_button.click()

            # Wait for the main interface to be ready after closing the modal
            page.wait_for_selector("#challengebox", timeout=10000)
            print("Challenge interface is ready.")

            # 8. Execute the auto-completer script
            print("Injecting and running the auto-completer script...")
            page.evaluate(AUTO_COMPLETER_JS)

            # 9. Wait for the script to finish by polling a flag
            print(
                "Waiting for all challenges to complete... This may take a few minutes."
            )
            is_finished = False
            while not is_finished:
                is_finished = page.evaluate("window.autoCompleterFinished")
                time.sleep(2)  # Check every 2 seconds

            print("Automation complete! The browser will close in 10 seconds.")
            time.sleep(10)

        except Exception as e:
            print(f"\nAn error occurred: {e}")
            print(
                "Please check your credentials and internet connection. If the error persists, the website structure may have changed."
            )

        finally:
            # Ensure the browser is closed even if an error occurs
            if "browser" in locals() and browser.is_connected():
                browser.close()
            print("Script finished.")


if __name__ == "__main__":
    main()
